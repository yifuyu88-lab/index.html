<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æˆç¸¾ç…§ä¼šï¼ˆå€‹äººç”¨ãƒ»éå…¬å¼ï¼‰</title>
<style>
  :root{
    --bg:#0b0f14; --card:#121926; --text:#e7edf7; --muted:#a7b3c7;
    --line:#243147; --btn:#2b6ef3; --btn2:#1a2436; --input:#0f1624;
    --shadow: 0 10px 30px rgba(0,0,0,.35); --radius:16px;
    --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  :root.light{
    --bg:#f6f7fb; --card:#ffffff; --text:#101828; --muted:#475467;
    --line:#e4e7ec; --btn:#2b6ef3; --btn2:#f2f4f7; --input:#ffffff;
    --shadow: 0 10px 30px rgba(16,24,40,.10);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;background:var(--bg);color:var(--text)}
  .container{width:min(1180px,94vw);margin:0 auto;padding:16px 0 36px}
  header{padding:14px 0 8px}
  h1{margin:0;font-size:20px;letter-spacing:.02em}
  .sub{margin:8px 0 0;color:var(--muted);line-height:1.45;font-size:13px}
  .banner{
    margin-top:10px; padding:10px 12px; border:1px solid var(--line);
    border-radius:14px; background: rgba(255,255,255,0.02);
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  }
  .who{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px; border:1px solid var(--line);
    font-size:12px; color:var(--muted);
    background: rgba(255,255,255,0.02);
  }
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
  .btn{border:0;padding:10px 12px;border-radius:12px;background:var(--btn);color:#fff;font-weight:800;cursor:pointer;white-space:nowrap}
  .btn.secondary{background:var(--btn2);color:var(--text);border:1px solid var(--line)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);margin-top:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .input, select, textarea{
    width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
    background:var(--input);color:var(--text);outline:none
  }
  .w260{width:260px;max-width:100%}
  .w220{width:220px;max-width:100%}
  .w200{width:200px;max-width:100%}
  .w180{width:180px;max-width:100%}
  .w140{width:140px;max-width:100%}
  .w120{width:120px;max-width:100%}
  .grid{display:grid;grid-template-columns:1.35fr .65fr;gap:12px}
  @media (max-width: 980px){.grid{grid-template-columns:1fr}}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px}
  @media (max-width: 700px){.kpi{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .kpi .box{border:1px solid var(--line);border-radius:14px;padding:10px}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .num{font-size:20px;font-weight:900;margin-top:6px}
  .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:14px;margin-top:10px}
  table{width:100%;border-collapse:separate;border-spacing:0;min-width:1040px}
  th,td{padding:10px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted);font-weight:900;position:sticky;top:0;background:var(--card);z-index:1}
  tr:hover td{background: rgba(255,255,255,0.02)}
  .tag{padding:3px 8px;border-radius:999px;font-size:12px;color:#fff;font-weight:900}
  .tag.good{background:var(--good)}
  .tag.warn{background:var(--warn)}
  .tag.bad{background:var(--bad)}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .mini{padding:7px 10px;border-radius:10px;font-weight:800}
  .notice{font-size:12px;color:var(--muted);line-height:1.6;margin-top:8px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .hidden{display:none !important}
  @media print{
    .no-print{display:none !important}
    body{background:#fff}
    .card,.banner{box-shadow:none}
    .tableWrap{border:1px solid #999}
  }
</style>
</head>
<body>
<div class="container">

  <header class="no-print">
    <h1>æˆç¸¾ç…§ä¼šï¼ˆå€‹äººç”¨ãƒ»éå…¬å¼ï¼‰</h1>
    <p class="sub">
      ã“ã‚Œã¯ <b>å·ä¸‹ å”¯æ–—ï¼ˆ4å›ç”Ÿï¼‰</b> ã®å€‹äººç”¨ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å¤§å­¦å…¬å¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
      ãƒ­ã‚°ã‚¤ãƒ³ã¯ç«¯æœ«å†…ãƒ­ãƒƒã‚¯ç”¨ã®PINã§ã™ã€‚ã“ã“ã§å…¥åŠ›ã™ã‚‹ã€Œç¢ºèªã‚³ãƒ¼ãƒ‰ã€ã¯éå…¬å¼ã®é€šéé …ç›®ã§ã€å…¬å¼ã®èªè¨¼æƒ…å ±ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
    </p>

    <div class="banner">
      <div class="who">
        <span class="chip">æ°åï¼š<b style="color:var(--text)">å·ä¸‹ å”¯æ–—</b></span>
        <span class="chip">å­¦å¹´ï¼š<b style="color:var(--text)">4å›ç”Ÿ</b></span>
        <span class="chip">ç¢ºèªã‚³ãƒ¼ãƒ‰ï¼š<b style="color:var(--text)" id="viewCodeLabel">â€”</b></span>
        <span class="pill" id="lockState">ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­</span>
      </div>
      <div class="row" style="width:auto">
        <button class="btn secondary" id="themeBtn" type="button">ãƒ†ãƒ¼ãƒåˆ‡æ›¿</button>
        <button class="btn secondary" id="exportBtn" type="button">æ›¸ãå‡ºã—</button>
        <button class="btn secondary" id="importBtn" type="button">èª­ã¿è¾¼ã¿</button>
        <button class="btn secondary" id="printBtn" type="button">å°åˆ·/PDF</button>
        <button class="btn secondary" id="wipeBtn" type="button">å…¨æ¶ˆå»</button>
      </div>
    </div>
  </header>

  <!-- Login -->
  <section class="card" id="loginCard">
    <h2 style="margin:0 0 10px;font-size:16px;">ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆç«¯æœ«å†…ãƒ­ãƒƒã‚¯è§£é™¤ï¼‰</h2>
    <p class="notice" style="margin:0 0 10px">
      ã€Œç¢ºèªã‚³ãƒ¼ãƒ‰ï¼ˆæ•°å­—ï¼‰ã€ã¯<b>éå…¬å¼</b>ã®é€šéé …ç›®ã§ã™ï¼ˆå¿…é ˆï¼‰ã€‚ãã®å¾Œã€PINã§ç«¯æœ«å†…ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã™ã€‚
    </p>

    <div class="row" style="margin: 0 0 10px">
      <input class="input w260" id="viewCodeInput" inputmode="numeric" pattern="[0-9]*"
             placeholder="ç¢ºèªã‚³ãƒ¼ãƒ‰ï¼ˆéå…¬å¼ãƒ»å¿…é ˆï¼‰ä¾‹ï¼š1234" />
      <span class="notice" style="margin:0">â€»å…¬å¼ã®èªè¨¼æƒ…å ±ã§ã¯ã‚ã‚Šã¾ã›ã‚“</span>
    </div>

    <div class="row">
      <input class="input w260" id="pinInput" placeholder="PINï¼ˆ4ã€œ20æ–‡å­—ï¼‰" />
      <button class="btn" id="loginBtn" type="button">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="btn secondary" id="setPinBtn" type="button">PINè¨­å®š/å¤‰æ›´</button>
    </div>

    <p class="notice">
      åˆå›ã¯ã€ŒPINè¨­å®š/å¤‰æ›´ã€ã§PINã‚’ä½œã£ã¦ãã ã•ã„ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚
    </p>
  </section>

  <!-- App -->
  <section class="card hidden" id="appCard">
    <div class="grid">
      <div>
        <div class="row no-print">
          <input class="input" id="searchInput" placeholder="æ¤œç´¢ï¼ˆç§‘ç›®å/ã‚³ãƒ¼ãƒ‰/æ‹…å½“/åŒºåˆ†/å¹´åº¦/å­¦æœŸ/å‚™è€ƒï¼‰" />
          <select id="filterYear" class="input w140">
            <option value="">å¹´åº¦ï¼šã™ã¹ã¦</option>
          </select>
          <select id="filterTerm" class="input w140">
            <option value="">å­¦æœŸï¼šã™ã¹ã¦</option>
            <option value="å‰æœŸ">å‰æœŸ</option>
            <option value="å¾ŒæœŸ">å¾ŒæœŸ</option>
            <option value="é€šå¹´">é€šå¹´</option>
            <option value="é›†ä¸­">é›†ä¸­</option>
          </select>
          <select id="filterCategory" class="input w140">
            <option value="">åŒºåˆ†ï¼šã™ã¹ã¦</option>
            <option value="å¿…ä¿®">å¿…ä¿®</option>
            <option value="é¸æŠ">é¸æŠ</option>
            <option value="æ•™é¤Š">æ•™é¤Š</option>
            <option value="å°‚é–€">å°‚é–€</option>
            <option value="è‡ªç”±">è‡ªç”±</option>
          </select>
          <button class="btn secondary" id="logoutBtn" type="button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div class="kpi" id="kpi"></div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:78px">å¹´åº¦</th>
                <th style="width:78px">å­¦æœŸ</th>
                <th style="width:110px">ç§‘ç›®ã‚³ãƒ¼ãƒ‰</th>
                <th>ç§‘ç›®å</th>
                <th style="width:130px">æ‹…å½“</th>
                <th style="width:90px">åŒºåˆ†</th>
                <th style="width:80px">å˜ä½</th>
                <th style="width:90px">è©•ä¾¡</th>
                <th style="width:90px">ç‚¹æ•°</th>
                <th style="width:220px">å‚™è€ƒ</th>
                <th class="no-print" style="width:150px">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <p class="notice">
          â€»éå…¬å¼ãƒ»å€‹äººç”¨ã€‚å…¬å¼ãƒ­ã‚´/å…¬å¼ç”»é¢ã®æ¨¡å€£ã¯ã—ã¦ã„ã¾ã›ã‚“ã€‚
        </p>
      </div>

      <div class="no-print">
        <h2 style="margin:0 0 10px;font-size:16px;">ç§‘ç›®ã‚’è¿½åŠ </h2>

        <div class="row">
          <input class="input w120" id="yearInput" placeholder="å¹´åº¦(ä¾‹:2025)" />
          <select class="input w140" id="termInput">
            <option value="å‰æœŸ">å‰æœŸ</option>
            <option value="å¾ŒæœŸ">å¾ŒæœŸ</option>
            <option value="é€šå¹´">é€šå¹´</option>
            <option value="é›†ä¸­">é›†ä¸­</option>
          </select>
          <input class="input w180" id="codeInput" placeholder="ç§‘ç›®ã‚³ãƒ¼ãƒ‰(ä»»æ„)" />
        </div>

        <div class="row" style="margin-top:10px">
          <input class="input" id="courseInput" placeholder="ç§‘ç›®å" />
        </div>

        <div class="row" style="margin-top:10px">
          <input class="input w200" id="teacherInput" placeholder="æ‹…å½“(ä»»æ„)" />
          <select class="input w140" id="categoryInput">
            <option value="å°‚é–€">å°‚é–€</option>
            <option value="æ•™é¤Š">æ•™é¤Š</option>
            <option value="å¿…ä¿®">å¿…ä¿®</option>
            <option value="é¸æŠ">é¸æŠ</option>
            <option value="è‡ªç”±">è‡ªç”±</option>
          </select>
          <input class="input w120" id="creditInput" placeholder="å˜ä½(ä¾‹:2)" />
        </div>

        <div class="row" style="margin-top:10px">
          <select class="input w140" id="gradeInput">
            <option value="">è©•ä¾¡(ä»»æ„)</option>
            <option value="S">S</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="F">F</option>
            <option value="åˆ">åˆ</option>
            <option value="å¦">å¦</option>
          </select>
          <input class="input w140" id="scoreInput" placeholder="ç‚¹æ•°(ä»»æ„)" />
        </div>

        <div class="row" style="margin-top:10px">
          <input class="input" id="noteInput" placeholder="å‚™è€ƒ(ä»»æ„)" />
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="addBtn" type="button">è¿½åŠ </button>
        </div>

        <div class="hr"></div>

        <details>
          <summary>CSVã§ä¸€æ‹¬è¿½åŠ ï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰</summary>
          <p class="notice">å½¢å¼ï¼šå¹´åº¦,å­¦æœŸ,ç§‘ç›®ã‚³ãƒ¼ãƒ‰,ç§‘ç›®å,æ‹…å½“,åŒºåˆ†,å˜ä½,è©•ä¾¡,ç‚¹æ•°,å‚™è€ƒ</p>
          <textarea class="input" id="csvInput" rows="8" spellcheck="false"
            placeholder="ä¾‹ï¼š
2025,å‰æœŸ,SS101,ç¤¾ä¼šã‚·ã‚¹ãƒ†ãƒ å…¥é–€,å±±ç”°,å°‚é–€,2,A,85,
2025,å¾ŒæœŸ,GP204,ç¾ä»£æ”¿ç­–æ¼”ç¿’,ä½è—¤,å¿…ä¿®,2,B,78,ãƒ¬ãƒãƒ¼ãƒˆé‡ã‚"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="importCsvBtn" type="button">CSVå–ã‚Šè¾¼ã¿</button>
          </div>
        </details>
      </div>
    </div>
  </section>

</div>

<script>
  const LS_KEY = "private_grade_site_v2";
  const state0 = { theme:"dark", pinHash:"", loggedIn:false, items:[], viewCode:"" };
  const $ = (id)=>document.getElementById(id);

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return structuredClone(state0);
      const s = JSON.parse(raw);
      return { ...structuredClone(state0), ...s };
    }catch{ return structuredClone(state0); }
  }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  async function hashText(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  let state = load();

  function applyTheme(){
    document.documentElement.classList.toggle("light", state.theme==="light");
  }
  $("themeBtn").addEventListener("click", ()=>{
    state.theme = state.theme==="light" ? "dark" : "light";
    save(); applyTheme();
  });
  applyTheme();

  function updateViewCodeLabel(){
    const el = $("viewCodeLabel");
    if(!el) return;
    el.textContent = (state.viewCode && String(state.viewCode).trim()) ? state.viewCode : "â€”";
  }

  function checkViewCodeRequired(){
    const v = ($("viewCodeInput")?.value || "").trim();

    // å¿…é ˆï¼šç©ºãªã‚‰é€šã•ãªã„
    if(!v){
      alert("ç¢ºèªã‚³ãƒ¼ãƒ‰ï¼ˆæ•°å­—ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆéå…¬å¼ãƒ»å¿…é ˆï¼‰ã€‚");
      return false;
    }
    // æ•°å­—ã®ã¿è¨±å¯
    if(!/^[0-9]+$/.test(v)){
      alert("ç¢ºèªã‚³ãƒ¼ãƒ‰ã¯æ•°å­—ã ã‘ã«ã—ã¦ãã ã•ã„ã€‚");
      return false;
    }

    state.viewCode = v;
    save();
    return true;
  }

  function showApp(show){
    $("loginCard").classList.toggle("hidden", show);
    $("appCard").classList.toggle("hidden", !show);
    $("lockState").textContent = show ? "ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³ä¸­" : "ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­";
    updateViewCodeLabel();
  }

  async function setPin(){
    if(!checkViewCodeRequired()) return;

    const pin = ($("pinInput").value||"").trim();
    if(pin.length < 4 || pin.length > 20){
      alert("PINã¯4ã€œ20æ–‡å­—ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    state.pinHash = await hashText(pin);
    state.loggedIn = true;
    save();
    showApp(true);
    renderAll();
    $("pinInput").value = "";
  }

  async function login(){
    if(!checkViewCodeRequired()) return;

    const pin = ($("pinInput").value||"").trim();
    if(!state.pinHash){
      alert("PINæœªè¨­å®šã§ã™ã€‚ã€ŒPINè¨­å®š/å¤‰æ›´ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    const h = await hashText(pin);
    if(h !== state.pinHash){
      alert("PINãŒé•ã„ã¾ã™ã€‚");
      return;
    }
    state.loggedIn = true;
    save();
    showApp(true);
    renderAll();
    $("pinInput").value = "";
  }

  function logout(){
    state.loggedIn = false;
    save();
    showApp(false);
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«å…¥åŠ›æ¬„ã¯æ®‹ã—ã¦OKï¼ˆå¥½ã¿ãªã‚‰æ¶ˆã—ã¦ã‚‚OKï¼‰
    // $("viewCodeInput").value = "";
  }

  $("setPinBtn").addEventListener("click", setPin);
  $("loginBtn").addEventListener("click", login);
  $("logoutBtn").addEventListener("click", logout);

  function gradeToPoints(g){
    const map = { "S":4.3, "A":4.0, "B":3.0, "C":2.0, "D":1.0, "F":0.0, "åˆ":null, "å¦":null, "":null };
    g = String(g||"").toUpperCase();
    return (g in map) ? map[g] : null;
  }
  function passTag(item){
    const g = String(item.grade||"").toUpperCase();
    const score = Number(item.score);
    if(g==="F" || g==="å¦") return "bad";
    if(String(item.score||"").trim()!=="" && !Number.isNaN(score)){
      if(score >= 80) return "good";
      if(score >= 60) return "warn";
      return "bad";
    }
    if(["S","A","B"].includes(g)) return "good";
    if(["C","D","åˆ"].includes(g)) return "warn";
    if(g) return "warn";
    return "warn";
  }

  function normalize(str){ return String(str||"").toLowerCase(); }

  function filteredItems(){
    const q = normalize($("searchInput").value);
    const y = $("filterYear").value;
    const t = $("filterTerm").value;
    const c = $("filterCategory").value;

    return state.items.filter(it=>{
      if(y && String(it.year) !== y) return false;
      if(t && String(it.term) !== t) return false;
      if(c && String(it.category) !== c) return false;

      if(!q) return true;
      const blob = [
        it.year,it.term,it.code,it.course,it.teacher,it.category,it.credits,it.grade,it.score,it.note
      ].map(normalize).join(" ");
      return blob.includes(q);
    });
  }

  function rebuildYearFilter(){
    const years = Array.from(new Set(state.items.map(it=>String(it.year||"")).filter(Boolean))).sort().reverse();
    const sel = $("filterYear");
    const cur = sel.value;
    sel.innerHTML = `<option value="">å¹´åº¦ï¼šã™ã¹ã¦</option>` + years.map(y=>`<option value="${escapeHtml(y)}">${escapeHtml(y)}</option>`).join("");
    if(years.includes(cur)) sel.value = cur;
  }

  function renderKPI(items){
    let total=0, earned=0, fail=0, gpaSum=0, gpaCredits=0;
    for(const it of items){
      const c = Number(it.credits);
      const has = !Number.isNaN(c) && c>0;
      if(has) total += c;

      const g = String(it.grade||"").toUpperCase();
      const isFail = (g==="F" || g==="å¦");
      if(isFail) fail++;

      if(!isFail && has) earned += c;

      const pts = gradeToPoints(g);
      if(pts != null && has){
        gpaSum += pts * c;
        gpaCredits += c;
      }
    }
    const gpa = gpaCredits ? (gpaSum/gpaCredits) : null;

    $("kpi").innerHTML = `
      <div class="box"><div class="label">è¡¨ç¤ºä¸­ã®ç§‘ç›®æ•°</div><div class="num">${items.length}</div></div>
      <div class="box"><div class="label">å–å¾—/åˆè¨ˆå˜ä½</div><div class="num">${earned}/${total}</div></div>
      <div class="box"><div class="label">GPAç›®å®‰</div><div class="num">${gpa==null?"â€”":gpa.toFixed(2)}</div></div>
      <div class="box"><div class="label">ä¸å¯/å¦</div><div class="num">${fail}</div></div>
    `;
  }

  function termOrder(term){
    const o = {"å‰æœŸ":1,"å¾ŒæœŸ":2,"é€šå¹´":3,"é›†ä¸­":4};
    return o[String(term||"")] ?? 9;
  }

  function sorted(items){
    return items.slice().sort((a,b)=>{
      const y = (Number(b.year)||0) - (Number(a.year)||0);
      if(y) return y;
      const t = termOrder(a.term) - termOrder(b.term);
      if(t) return t;
      return String(a.course||"").localeCompare(String(b.course||""),"ja");
    });
  }

  function renderTable(){
    const items = sorted(filteredItems());
    renderKPI(items);

    const tbody = $("rows");
    tbody.innerHTML = "";

    items.forEach((it)=>{
      const tag = passTag(it);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(it.year||"")}</td>
        <td>${escapeHtml(it.term||"")}</td>
        <td>${escapeHtml(it.code||"")}</td>
        <td><b>${escapeHtml(it.course||"")}</b></td>
        <td>${escapeHtml(it.teacher||"")}</td>
        <td>${escapeHtml(it.category||"")}</td>
        <td>${escapeHtml(it.credits||"")}</td>
        <td><span class="tag ${tag}">${escapeHtml((it.grade||"") || "â€”")}</span></td>
        <td>${escapeHtml((it.score||"") || "â€”")}</td>
        <td>${escapeHtml(it.note||"")}</td>
        <td class="no-print">
          <div class="actions">
            <button class="btn secondary mini" data-act="edit" data-id="${escapeHtml(it.id)}" type="button">ç·¨é›†</button>
            <button class="btn secondary mini" data-act="del" data-id="${escapeHtml(it.id)}" type="button">å‰Šé™¤</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    if(items.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="11" class="muted" style="padding:14px">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td>`;
      tbody.appendChild(tr);
    }
  }

  function readInputs(){
    const year = ($("yearInput").value||"").trim();
    const term = $("termInput").value;
    const code = ($("codeInput").value||"").trim();
    const course = ($("courseInput").value||"").trim();
    const teacher = ($("teacherInput").value||"").trim();
    const category = $("categoryInput").value;
    const credits = ($("creditInput").value||"").trim();
    const grade = ($("gradeInput").value||"").trim();
    const score = ($("scoreInput").value||"").trim();
    const note = ($("noteInput").value||"").trim();

    if(!year || !course || !credits){
      alert("æœ€ä½é™ã€Œå¹´åº¦ãƒ»ç§‘ç›®åãƒ»å˜ä½ã€ã¯å…¥ã‚Œã¦ãã ã•ã„ã€‚");
      return null;
    }
    return { id: crypto.randomUUID(), year, term, code, course, teacher, category, credits, grade, score, note, createdAt: Date.now() };
  }

  $("addBtn").addEventListener("click", ()=>{
    const item = readInputs();
    if(!item) return;
    state.items.push(item);
    save();
    rebuildYearFilter();
    renderTable();

    ["yearInput","codeInput","courseInput","teacherInput","creditInput","gradeInput","scoreInput","noteInput"].forEach(id=>$(id).value="");
    $("termInput").value = "å‰æœŸ";
    $("categoryInput").value = "å°‚é–€";
  });

  $("rows").addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    const it = state.items.find(x=>x.id===id);
    if(!it) return;

    if(act === "del"){
      if(!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${it.year} ${it.term} ${it.course}`)) return;
      state.items = state.items.filter(x=>x.id!==id);
      save(); rebuildYearFilter(); renderTable();
      return;
    }

    if(act === "edit"){
      const year = prompt("å¹´åº¦", it.year) ?? it.year;
      const term = prompt("å­¦æœŸï¼ˆå‰æœŸ/å¾ŒæœŸ/é€šå¹´/é›†ä¸­ï¼‰", it.term) ?? it.term;
      const code = prompt("ç§‘ç›®ã‚³ãƒ¼ãƒ‰", it.code) ?? it.code;
      const course = prompt("ç§‘ç›®å", it.course) ?? it.course;
      const teacher = prompt("æ‹…å½“", it.teacher) ?? it.teacher;
      const category = prompt("åŒºåˆ†ï¼ˆå¿…ä¿®/é¸æŠ/æ•™é¤Š/å°‚é–€/è‡ªç”±ï¼‰", it.category) ?? it.category;
      const credits = prompt("å˜ä½", it.credits) ?? it.credits;
      const grade = prompt("è©•ä¾¡ï¼ˆS/A/B/C/D/F/åˆ/å¦ï¼‰", it.grade) ?? it.grade;
      const score = prompt("ç‚¹æ•°", it.score) ?? it.score;
      const note = prompt("å‚™è€ƒ", it.note) ?? it.note;

      const updated = { ...it, year, term, code, course, teacher, category, credits, grade, score, note, updatedAt: Date.now() };
      state.items = state.items.map(x=> x.id===id ? updated : x);
      save(); rebuildYearFilter(); renderTable();
    }
  });

  $("searchInput").addEventListener("input", renderTable);
  $("filterYear").addEventListener("change", renderTable);
  $("filterTerm").addEventListener("change", renderTable);
  $("filterCategory").addEventListener("change", renderTable);

  $("importCsvBtn").addEventListener("click", ()=>{
    const text = ($("csvInput").value||"").trim();
    if(!text){ alert("CSVãŒç©ºã§ã™"); return; }
    const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);
    let ok=0, ng=0;
    for(const line of lines){
      const cols = line.split(",").map(s=>s.trim());
      if(cols.length < 7){ ng++; continue; }
      const [year, term, code, course, teacher, category, credits, grade="", score="", note=""] = cols;
      if(!year || !term || !course || !credits){ ng++; continue; }
      state.items.push({
        id: crypto.randomUUID(), year, term, code, course, teacher, category, credits, grade, score, note, createdAt: Date.now()
      });
      ok++;
    }
    save();
    rebuildYearFilter();
    renderTable();
    alert(`å–ã‚Šè¾¼ã¿å®Œäº†ï¼š${ok}ä»¶ï¼ˆå¤±æ•— ${ng}ä»¶ï¼‰`);
  });

  $("exportBtn").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "grade_site_backup.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  $("importBtn").addEventListener("click", ()=>{
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = async ()=>{
      const file = input.files?.[0];
      if(!file) return;
      const text = await file.text();
      try{
        const parsed = JSON.parse(text);
        state = { ...state0, ...parsed };
        save();
        applyTheme();
        showApp(!!state.loggedIn);
        if(state.loggedIn){ renderAll(); }
        alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
      }catch{
        alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    };
    input.click();
  });

  $("printBtn").addEventListener("click", ()=>window.print());

  $("wipeBtn").addEventListener("click", ()=>{
    if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ã¾ã™ã€‚æœ¬å½“ã«ã„ã„ï¼Ÿ")) return;
    localStorage.removeItem(LS_KEY);
    state = structuredClone(state0);
    applyTheme();
    showApp(false);
    $("pinInput").value = "";
    $("viewCodeInput").value = "";
    alert("æ¶ˆå»ã—ã¾ã—ãŸã€‚");
  });

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function renderAll(){
    rebuildYearFilter();
    renderTable();
    updateViewCodeLabel();
  }

  // Init
  showApp(!!state.loggedIn);
  updateViewCodeLabel();
  if(state.loggedIn){ renderAll(); }
</script>
</body>
</html>
